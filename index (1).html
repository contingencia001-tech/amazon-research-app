<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Investigación de Productos Amazon</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h1 { text-align: center; color: #333; }
    nav { margin-bottom: 20px; text-align: center; }
    nav button { margin: 5px; padding: 10px 20px; border: none; border-radius: 5px; background: #007bff; color: white; cursor: pointer; }
    nav button:hover { background: #0056b3; }
    section { display: none; }
    section.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; background: white; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
    th { background: #e9ecef; font-weight: bold; }
    tr:nth-child(even) { background: #f2f2f2; }
    .kpi { display: inline-block; margin: 15px; padding: 15px; background: #fff; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); min-width: 180px; }
    .kpi h2 { margin: 0; font-size: 22px; }
    #top10 { margin-top: 20px; background: #fff; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <h1>Investigación de Mercado - Amazon</h1>

  <nav>
    <button onclick="showTab('atributos')">Atributos de Productos</button>
    <button onclick="showTab('investigacion')">Investigación de Productos</button>
    <button onclick="showTab('dashboard')">Dashboard Gerencial</button>
  </nav>

  <!-- Hoja 1 -->
  <section id="atributos" class="active">
    <h2><b>Atributos de Productos</b></h2>
    <input type="file" id="fileAtributos" accept=".xlsx" />
    <div id="tablaAtributos"></div>
  </section>

  <!-- Hoja 2 -->
  <section id="investigacion">
    <h2><b>Investigación de Productos</b></h2>
    <input type="file" id="fileInvestigacion" accept=".xlsx" />
    <div id="tablaInvestigacion"></div>
  </section>

  <!-- Hoja 3 -->
  <section id="dashboard">
    <h2><b>Dashboard Gerencial</b></h2>

    <div class="kpi"><h2 id="totalCompetidores">-</h2><p>Total Competidores</p></div>
    <div class="kpi"><h2 id="precioPromedio">-</h2><p>Precio Promedio</p></div>
    <div class="kpi"><h2 id="precioPromedio20">-</h2><p>Precio Promedio Top 20 Sellers</p></div>
    <div class="kpi"><h2 id="numProductos">-</h2><p>Número de Productos</p></div>
    <div class="kpi"><h2 id="asinRevenueTop10">-</h2><p>ASIN Revenue Top 10</p></div>
    <div class="kpi"><h2 id="asinRevenuePromedio">-</h2><p>ASIN Revenue Promedio</p></div>
    <div class="kpi"><h2 id="activeSellers">-</h2><p>Active Sellers</p></div>

    <div id="top10">
      <h3>Top 10 Competidores</h3>
      <ul id="listaTop10"></ul>
    </div>

    <canvas id="grafico" width="500" height="200"></canvas>
  </section>

  <script>
    function showTab(tabId) {
      document.querySelectorAll("section").forEach(sec => sec.classList.remove("active"));
      document.getElementById(tabId).classList.add("active");
    }

    // Leer Excel y mostrar en tabla
    function handleFile(inputId, outputId) {
      const input = document.getElementById(inputId);
      input.addEventListener("change", (e) => {
        const file = e.target.files[0];
        const reader = new FileReader();
        reader.onload = (evt) => {
          const data = new Uint8Array(evt.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          const json = XLSX.utils.sheet_to_json(sheet, { header: 1 });
          renderTable(json, outputId);
          if (outputId === "tablaInvestigacion") calcularDashboard(json);
        };
        reader.readAsArrayBuffer(file);
      });
    }

    function renderTable(data, outputId) {
      let html = "<table><thead><tr>";
      data[0].forEach(col => { html += `<th>${col}</th>`; });
      html += "</tr></thead><tbody>";
      for (let i = 1; i < data.length && i <= 100; i++) {
        html += "<tr>";
        data[i].forEach(cell => { html += `<td contenteditable='true'>${cell || ""}</td>`; });
        html += "</tr>";
      }
      html += "</tbody></table>";
      document.getElementById(outputId).innerHTML = html;
    }

    // Dashboard con cálculos avanzados
    function calcularDashboard(data) {
      let precios = [];
      let ventas = [];
      let revenue = [];
      let competidores = {};
      let paises = {};

      for (let i = 1; i < data.length; i++) {
        let asin = data[i][0];
        let seller = data[i][1];
        let precio = parseFloat(data[i][2]);
        let volumen = parseInt(data[i][3]);
        let venta = parseInt(data[i][4]);
        let rev = parseFloat(data[i][5]);
        let pais = data[i][6];

        if (!isNaN(precio)) precios.push(precio);
        if (!isNaN(venta)) ventas.push({ asin, seller, venta });
        if (!isNaN(rev)) revenue.push({ asin, seller, rev });

        if (seller) competidores[seller] = (competidores[seller] || 0) + (rev || 0);
        if (pais) paises[pais] = (paises[pais] || 0) + 1;
      }

      // KPI básicos
      const avgPrecio = precios.reduce((a,b) => a+b, 0) / precios.length || 0;
      const avgPrecio20 = precios.slice(0,20).reduce((a,b)=>a+b,0) / Math.min(20, precios.length);

      document.getElementById("precioPromedio").innerText = "$" + avgPrecio.toFixed(2);
      document.getElementById("precioPromedio20").innerText = "$" + avgPrecio20.toFixed(2);
      document.getElementById("numProductos").innerText = data.length - 1;
      document.getElementById("totalCompetidores").innerText = Object.keys(competidores).length;

      // Top 10 competidores
      let top10 = Object.entries(competidores)
                        .sort((a,b)=>b[1]-a[1])
                        .slice(0,10);
      let lista = document.getElementById("listaTop10");
      lista.innerHTML = "";
      top10.forEach(([seller, rev]) => {
        let li = document.createElement("li");
        li.innerText = seller + " - Revenue: $" + rev.toFixed(2);
        lista.appendChild(li);
      });

      // Revenue Top 10 y Promedio
      const revTop10 = top10.reduce((a,b)=>a+b[1],0);
      const avgRev = revenue.reduce((a,b)=>a+b.rev,0) / revenue.length;

      document.getElementById("asinRevenueTop10").innerText = "$" + revTop10.toFixed(2);
      document.getElementById("asinRevenuePromedio").innerText = "$" + avgRev.toFixed(2);

      // Active sellers
      const active = ventas.filter(v=>v.venta>0).length;
      document.getElementById("activeSellers").innerText = active;

      // Chart
      new Chart(document.getElementById("grafico"), {
        type: "bar",
        data: {
          labels: revenue.map(r=>r.asin).slice(0,20),
          datasets: [
            { label: "Revenue", data: revenue.map(r=>r.rev).slice(0,20) },
            { label: "Ventas", data: ventas.map(v=>v.venta).slice(0,20) }
          ]
        }
      });
    }

    // Inicializar
    handleFile("fileAtributos", "tablaAtributos");
    handleFile("fileInvestigacion", "tablaInvestigacion");
  </script>
</body>
</html>